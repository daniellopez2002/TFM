name: Unreal Engine ‚Äî Build & Release (UE 5.5)

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build:
    name: Build Unreal Project
    runs-on: [self-hosted, Windows, X64, Local-1]

    env:
      UE_PATH: ${{ secrets.UE_PATH }}
      PROJECT_PATH: ${{ secrets.PROJECT_PATH }}
      BUILD_PLATFORM: "Win64"
      BUILD_CONFIG: "Shipping"
      ARCHIVE_DIR: "C:\\actions-runner\\_work\\TFM\\Build\\WindowsNoEditor"

    steps:
      # 1Ô∏è‚É£ Clona el repositorio completo (incluyendo LFS)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      # 2Ô∏è‚É£ Cache incremental (compilaci√≥n y datos derivados)
      - name: Cache Unreal Derived Data
        uses: actions/cache@v4
        with:
          path: |
            C:\actions-runner\_work\TFM\TFM\DerivedDataCache
            C:\actions-runner\_work\TFM\TFM\Intermediate
            C:\actions-runner\_work\TFM\TFM\Saved
          key: ue5-cache-${{ env.BUILD_PLATFORM }}-${{ env.BUILD_CONFIG }}-${{ hashFiles('Source/**/*.cpp', 'Source/**/*.h', 'Content/**/*.uasset', 'Content/**/*.umap') }}
          restore-keys: |
            ue5-cache-${{ env.BUILD_PLATFORM }}-${{ env.BUILD_CONFIG }}-

      # 3Ô∏è‚É£ Muestra informaci√≥n del entorno y secretos (sin revelar valores)
      - name: Verify environment
        shell: powershell
        run: |
          Write-Host "Runner: $env:COMPUTERNAME"
          if ($env:UE_PATH -and $env:PROJECT_PATH) {
            Write-Host "‚úÖ Secrets loaded successfully."
          } else {
            Write-Error "‚ùå Secrets not found. Check UE_PATH and PROJECT_PATH."
          }
          Write-Host "Build Platform: $env:BUILD_PLATFORM"
          Write-Host "Build Config: $env:BUILD_CONFIG"

      # 4Ô∏è‚É£ Ejecuta el build con Unreal Automation Tool (UAT)
      - name: Build, Cook, and Package (Incremental UAT)
        shell: powershell
        run: |
          $uat = "$env:UE_PATH\Engine\Build\BatchFiles\RunUAT.bat"
          if (!(Test-Path $uat)) {
            Write-Error "‚ùå RunUAT.bat not found at $uat"
            exit 1
          }

          $platform = $env:BUILD_PLATFORM
          $config = $env:BUILD_CONFIG
          $project = $env:PROJECT_PATH
          $archive = $env:ARCHIVE_DIR

          Write-Host "üöÄ Starting Incremental BuildCookRun for $platform - $config ..."
          
          $arguments = @(
            "BuildCookRun",
            "-project=`"$project`"",
            "-noP4",
            "-platform=$platform",
            "-clientconfig=$config",
            "-build", "-cook", "-stage", "-pak", "-archive", "-package", "-client",
            "-archivedirectory=`"$archive`"",
            "-utf8output",
            "-iterate", "-cookpartialgc",
            "-CrashReporter", "-nocompileeditor", "-NoDebugInfo"
          )

          & $uat @arguments | Tee-Object -FilePath "$archive\..\BuildLog.txt"

          if ($LASTEXITCODE -ne 0) {
            Write-Error "‚ùå Unreal BuildCookRun failed. Check BuildLog.txt for details."
            exit $LASTEXITCODE
          } else {
            Write-Host "‚úÖ BuildCookRun completed successfully."
          }


      # 5Ô∏è‚É£ Comprime el build final jugable
      - name: Compress build
        shell: powershell
        run: |
          $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
          $buildDir = "C:\\actions-runner\\_work\\TFM\\Build\\WindowsNoEditor"
          $zipPath = "C:\\actions-runner\\_work\\TFM\\Build\\TFM_GameBuild_${{ github.run_number }}_${timestamp}_${env.BUILD_PLATFORM}_${env.BUILD_CONFIG}.zip"

          Write-Host "üì¶ Compressing build to: $zipPath"
          Compress-Archive -Path "$buildDir\\*" -DestinationPath $zipPath -Force

          if (!(Test-Path $zipPath)) {
            Write-Error "‚ùå ZIP file was not created."
            exit 1
          } else {
            Write-Host "‚úÖ Game packaged successfully at: $zipPath"
          }

          Add-Content -Path $env:GITHUB_ENV -Value "ZIP_PATH=$zipPath"

      # 6Ô∏è‚É£ Publica el release en GitHub
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: "TFM Build ${{ github.run_number }}"
          body: |
            üéÆ **TFM ‚Äî Unreal Engine 5.5 Incremental Build (Playable)**  
            ‚úÖ Platform: ${{ env.BUILD_PLATFORM }}  
            ‚öôÔ∏è Config: ${{ env.BUILD_CONFIG }}  
            üïê Timestamp: ${{ github.run_id }}
          files: |
            ${{ env.ZIP_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
