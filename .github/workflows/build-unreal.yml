name: Unreal Engine â€” Build & Release (UE 5.5)

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build:
    name: Build Unreal Project
    runs-on: [self-hosted, Windows, X64, Local-1]

    env:
      UE_PATH: ${{ secrets.UE_PATH }}
      PROJECT_PATH: ${{ secrets.PROJECT_PATH }}
      BUILD_PLATFORM: "Win64"
      BUILD_CONFIG: "Shipping"
      ARCHIVE_DIR: "C:\\actions-runner\\_work\\TFM\\Build"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Verify environment
        shell: powershell
        run: |
          Write-Host "Runner: $env:COMPUTERNAME"
          if ($env:UE_PATH -and $env:PROJECT_PATH) {
              Write-Host "Secrets loaded successfully."
          } else {
              Write-Error "Secrets not found. Check UE_PATH and PROJECT_PATH."
          }
          Write-Host "Build Platform: $env:BUILD_PLATFORM"
          Write-Host "Build Config: $env:BUILD_CONFIG"

      - name: Build, Cook, and Package (UAT)
        shell: powershell
        run: |
          $uePath = $env:UE_PATH.Trim('"').Trim()
          $uat = Join-Path $uePath "Engine\Build\BatchFiles\RunUAT.bat"
          $logDir = $env:ARCHIVE_DIR
          $logFile = Join-Path $logDir "BuildLog.txt"

          if (!(Test-Path $logDir)) {
              Write-Host "Creating output directory: $logDir"
              New-Item -ItemType Directory -Path $logDir -Force | Out-Null
          }

          if (!(Test-Path $uat)) {
              Write-Error "RunUAT.bat not found at $uat"
              exit 1
          }

          Write-Host "Starting BuildCookRun..."
          Write-Host "Project: $env:PROJECT_PATH"
          Write-Host "Output: $logDir"

          $args = @(
              "BuildCookRun",
              "-project=$env:PROJECT_PATH",
              "-noP4",
              "-platform=$env:BUILD_PLATFORM",
              "-clientconfig=$env:BUILD_CONFIG",
              "-build",
              "-cook",
              "-stage",
              "-pak",
              "-archive",
              "-archivedirectory=$env:ARCHIVE_DIR",
              "-utf8output",
              "-CrashReporter",
              "-nocompileeditor",
              "-NoDebugInfo"
          )

          & "$uat" @args 2>&1 | Tee-Object -FilePath $logFile

          if ($LASTEXITCODE -ne 0) {
              Write-Error "Unreal BuildCookRun failed. Check BuildLog.txt for details."
              exit $LASTEXITCODE
          } else {
              Write-Host "BuildCookRun completed successfully."
          }

      - name: Compress build
        shell: powershell
        run: |
          $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
          $zipPath = "$env:ARCHIVE_DIR\TFM_Build_${{ github.run_number }}_${timestamp}_${env.BUILD_PLATFORM}_${env.BUILD_CONFIG}.zip"

          Write-Host "Compressing build to: $zipPath"
          Compress-Archive -Path "$env:ARCHIVE_DIR\*" -DestinationPath $zipPath -Force

          if (!(Test-Path $zipPath)) {
              Write-Error "ZIP file was not created."
              exit 1
          } else {
              Write-Host "Build packaged successfully at: $zipPath"
          }

          echo "ZIP_PATH=$zipPath" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: "TFM Build ${{ github.run_number }}"
          body: |
            Automated Unreal Engine 5.5 Build  
            Platform: ${{ env.BUILD_PLATFORM }}  
            Config: ${{ env.BUILD_CONFIG }}  
            Timestamp: ${{ github.run_id }}
          files: |
            ${{ env.ZIP_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
